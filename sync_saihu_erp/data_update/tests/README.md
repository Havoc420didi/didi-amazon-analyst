# æ•°æ®åŒæ­¥ç³»ç»Ÿæµ‹è¯•æ–‡æ¡£

æœ¬æµ‹è¯•å¥—ä»¶ç”¨äºéªŒè¯èµ›ç‹ERPæ•°æ®åŒæ­¥ç³»ç»Ÿçš„å„é¡¹åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­èƒ½å¤Ÿç¨³å®šè¿è¡Œã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

- âœ… éªŒè¯APIè®¤è¯æœºåˆ¶ï¼ˆOAuth2/API Keyï¼‰
- âœ… éªŒè¯ä¸‰ç±»æ•°æ®çš„æŠ“å–åŠŸèƒ½ï¼ˆäº§å“åˆ†æã€FBAåº“å­˜ã€åº“å­˜æ˜ç»†ï¼‰
- âœ… éªŒè¯æ•°æ®å¤„ç†é€»è¾‘ï¼ˆæ¸…æ´—ã€è½¬æ¢ã€å»é‡ï¼‰
- âœ… éªŒè¯æ•°æ®åº“æ“ä½œï¼ˆè¿æ¥ã€CRUDã€äº‹åŠ¡ï¼‰
- âœ… éªŒè¯ç³»ç»Ÿé›†æˆæ€§å’Œç¨³å®šæ€§
- âœ… éªŒè¯é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

## ğŸ“ æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ integration/                    # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_auth_flow.py          # APIè®¤è¯æµç¨‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_data_fetch.py         # æ•°æ®æŠ“å–åŠŸèƒ½æµ‹è¯•
â”‚   â””â”€â”€ test_sync_flow.py          # å®Œæ•´åŒæ­¥æµç¨‹æµ‹è¯•
â”œâ”€â”€ unit/                          # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_models.py             # æ•°æ®æ¨¡å‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_processors.py         # æ•°æ®å¤„ç†å™¨æµ‹è¯•
â”‚   â””â”€â”€ test_database.py           # æ•°æ®åº“æ“ä½œæµ‹è¯•
â”œâ”€â”€ utils/                         # æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ test_config.py             # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ mock_server.py             # æ¨¡æ‹ŸAPIæœåŠ¡å™¨
â”‚   â””â”€â”€ data_generator.py          # æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
â”œâ”€â”€ fixtures/                      # æµ‹è¯•æ•°æ®
â”‚   â”œâ”€â”€ sample_responses.json      # æ¨¡æ‹ŸAPIå“åº”
â”‚   â””â”€â”€ test_data.sql              # æµ‹è¯•æ•°æ®SQL
â”œâ”€â”€ output/                        # æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ test_reports/              # æµ‹è¯•æŠ¥å‘Š
â”‚   â””â”€â”€ logs/                      # æµ‹è¯•æ—¥å¿—
â”œâ”€â”€ test_runner.py                 # æµ‹è¯•è¿è¡Œå™¨
â””â”€â”€ README.md                      # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/hudi_data/sync_saihu_erp/data_update

# å®‰è£…æµ‹è¯•ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡æœ‰å®‰è£…ï¼‰
pip install pytest pytest-cov requests-mock

# åˆ›å»ºæµ‹è¯•è¾“å‡ºç›®å½•
mkdir -p tests/output/logs
mkdir -p tests/output/reports
```

### 2. é…ç½®æµ‹è¯•ç¯å¢ƒ

ç¼–è¾‘æµ‹è¯•é…ç½®æ–‡ä»¶ `tests/utils/test_config.py`ï¼š

```python
# æ›´æ–°ä½ çš„è®¤è¯ä¿¡æ¯
TEST_AUTH_CONFIG = {
    "client_id": "368000",  # ä½ çš„clientId
    "client_secret": "3cc6efdf-6861-42e0-b9a5-874a0296640b",  # ä½ çš„clientSecret
    "auth_type": "oauth2"
}

# æ›´æ–°APIåŸºç¡€URLï¼ˆå¦‚æœéœ€è¦ï¼‰
TEST_API_CONFIG = {
    "base_url": "https://api.saihu-erp.com",
    # ... å…¶ä»–é…ç½®
}
```

### 3. è¿è¡Œæµ‹è¯•

#### æ–¹å¼ä¸€ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
python tests/test_runner.py

# æµ‹è¯•å®Œæˆåä¼šç”Ÿæˆè¯¦ç»†çš„HTMLå’ŒJSONæŠ¥å‘Š
```

#### æ–¹å¼äºŒï¼šå•ç‹¬è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# åªè¿è¡Œè®¤è¯æµ‹è¯•
python tests/integration/test_auth_flow.py

# åªè¿è¡Œæ•°æ®æŠ“å–æµ‹è¯•
python tests/integration/test_data_fetch.py

# ä½¿ç”¨pytestè¿è¡Œï¼ˆéœ€è¦å®‰è£…pytestï¼‰
pytest tests/integration/test_auth_flow.py -v
```

## ğŸ“Š æµ‹è¯•è¯´æ˜

### 1. APIè®¤è¯æµ‹è¯• (`test_auth_flow.py`)

**æµ‹è¯•å†…å®¹ï¼š**
- OAuth2å®¢æˆ·ç«¯å‡­è¯æµç¨‹
- API Keyè®¤è¯æµç¨‹  
- Bearer Tokenä½¿ç”¨
- Tokenåˆ·æ–°æœºåˆ¶
- æ— æ•ˆå‡­è¯å¤„ç†
- APIé™æµå¤„ç†

**é¢„æœŸç»“æœï¼š**
```
=== OAuth2è®¤è¯æµç¨‹ ===
Client ID: 368000
Client Secret: 3cc6efdf...
å‘é€è®¤è¯è¯·æ±‚åˆ°: https://api.saihu-erp.com/oauth/token
è®¤è¯å“åº”çŠ¶æ€ç : 200
âœ… OAuth2è®¤è¯æµ‹è¯•é€šè¿‡
```

**å¸¸è§é—®é¢˜ï¼š**
- `è®¤è¯å¤±è´¥: 401` - æ£€æŸ¥clientIdå’ŒclientSecretæ˜¯å¦æ­£ç¡®
- `è¿æ¥è¶…æ—¶` - æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡å™¨çŠ¶æ€
- `403æƒé™ä¸è¶³` - æ£€æŸ¥è´¦æˆ·æƒé™å’ŒAPIè®¿é—®èŒƒå›´

### 2. æ•°æ®æŠ“å–æµ‹è¯• (`test_data_fetch.py`)

**æµ‹è¯•å†…å®¹ï¼š**
- äº§å“åˆ†ææ•°æ®æŠ“å–ï¼ˆå‰ä¸€å¤©æ•°æ® + å‰7å¤©æ›´æ–°ï¼‰
- FBAåº“å­˜æ•°æ®æŠ“å–ï¼ˆå½“å¤©å…¨é‡æ•°æ®ï¼‰
- åº“å­˜æ˜ç»†æ•°æ®æŠ“å–ï¼ˆå½“å¤©è¯¦ç»†æ•°æ®ï¼‰
- åˆ†é¡µæ•°æ®å¤„ç†
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- é™æµéµå®ˆæƒ…å†µ

**é¢„æœŸç»“æœï¼š**
```
=== æµ‹è¯•äº§å“åˆ†ææ•°æ®æŠ“å– ===
1. æµ‹è¯•å‰ä¸€å¤©æ•°æ®æŠ“å–...
å‰ä¸€å¤©æ•°æ®æ•°é‡: 15
2. æµ‹è¯•å‰7å¤©å†å²æ•°æ®æŠ“å–...
å‰7å¤©æ•°æ®æ•°é‡: 105
âœ… äº§å“åˆ†ææ•°æ®æŠ“å–æµ‹è¯•é€šè¿‡
```

**æ•°æ®æ ¼å¼éªŒè¯ï¼š**
- äº§å“åˆ†ææ•°æ®å¿…é¡»åŒ…å«ï¼š`product_id`, `data_date`, `sales_amount`ç­‰å­—æ®µ
- FBAåº“å­˜æ•°æ®å¿…é¡»åŒ…å«ï¼š`sku`, `marketplace_id`, `available_quantity`ç­‰å­—æ®µ
- åº“å­˜æ˜ç»†æ•°æ®å¿…é¡»åŒ…å«ï¼š`item_id`, `warehouse_code`, `quantity`ç­‰å­—æ®µ

### 3. ç³»ç»Ÿé›†æˆæµ‹è¯• (`test_runner.py`)

**æµ‹è¯•æµç¨‹ï¼š**
1. **é…ç½®éªŒè¯** - æ£€æŸ¥ç³»ç»Ÿé…ç½®çš„åŠ è½½å’Œæœ‰æ•ˆæ€§
2. **æ•°æ®åº“è¿æ¥** - éªŒè¯æ•°æ®åº“è¿æ¥å’ŒåŸºæœ¬æŸ¥è¯¢
3. **ç»„ä»¶é›†æˆ** - éªŒè¯å„æ¨¡å—çš„ååŒå·¥ä½œ
4. **è®¤è¯åŠŸèƒ½** - å®Œæ•´çš„APIè®¤è¯æµç¨‹æµ‹è¯•
5. **æ•°æ®æŠ“å–** - ä¸‰ç±»æ•°æ®çš„æŠ“å–åŠŸèƒ½æµ‹è¯•

**æŠ¥å‘Šç”Ÿæˆï¼š**
- HTMLæŠ¥å‘Šï¼š`tests/output/test_report_YYYYMMDD_HHMMSS.html`
- JSONæŠ¥å‘Šï¼š`tests/output/test_report_YYYYMMDD_HHMMSS.json`

## ğŸ”§ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–æµ‹è¯•é…ç½®ï¼š

```bash
# è®¾ç½®æµ‹è¯•æ•°æ®åº“
export TEST_DB_HOST=localhost
export TEST_DB_PORT=3306
export TEST_DB_USER=test_user
export TEST_DB_PASSWORD=test_password
export TEST_DB_NAME=amazon_analyst_test

# è®¾ç½®APIåŸºç¡€URL
export TEST_API_BASE_URL=https://api-test.saihu-erp.com
```

### æµ‹è¯•æ•°æ®é…ç½®

åœ¨ `tests/utils/test_config.py` ä¸­å¯ä»¥é…ç½®ï¼š

```python
# æµ‹è¯•ç”¨çš„äº§å“IDã€SKUã€å¸‚åœºIDç­‰
TEST_DATA_CONFIG = {
    "sample_product_ids": ["PROD001", "PROD002", "PROD003"],
    "sample_skus": ["SKU001", "SKU002", "SKU003"], 
    "sample_marketplace_ids": ["ATVPDKIKX0DER", "A1PA6795UKMFR9"],
    "sample_warehouse_codes": ["WH001", "WH002"],
    "test_date_range": {
        "start_date": "2025-07-16",
        "end_date": "2025-07-22"
    }
}
```

## ğŸ“ˆ æµ‹è¯•ç»“æœåˆ†æ

### æˆåŠŸæ ‡å‡†

- **è®¤è¯æµ‹è¯•**ï¼šè‡³å°‘70%çš„æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- **æ•°æ®æŠ“å–æµ‹è¯•**ï¼šè‡³å°‘80%çš„æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- **é›†æˆæµ‹è¯•**ï¼šè‡³å°‘80%çš„ç»„ä»¶æ­£å¸¸å·¥ä½œ
- **æ•´ä½“æµ‹è¯•**ï¼šè‡³å°‘80%çš„æµ‹è¯•å¥—ä»¶é€šè¿‡

### å¸¸è§å¤±è´¥åŸå› åŠè§£å†³æ–¹æ¡ˆ

#### 1. è®¤è¯å¤±è´¥
```
âŒ OAuth2è®¤è¯æµ‹è¯•å¤±è´¥: 401 Unauthorized
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥clientIdå’ŒclientSecretæ˜¯å¦æ­£ç¡®
- ç¡®è®¤APIæœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

#### 2. æ•°æ®æŠ“å–å¤±è´¥
```
âŒ äº§å“åˆ†ææ•°æ®æŠ“å–æµ‹è¯•å¤±è´¥: 403 Forbidden
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥APIè®¿é—®æƒé™å’ŒèŒƒå›´
- ç¡®è®¤è´¦æˆ·æ˜¯å¦æœ‰ç›¸åº”çš„æ•°æ®è®¿é—®æƒé™
- æ£€æŸ¥APIé™æµè®¾ç½®

#### 3. æ•°æ®åº“è¿æ¥å¤±è´¥
```
âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: Can't connect to MySQL server
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨
- éªŒè¯æ•°æ®åº“è¿æ¥é…ç½®
- ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æƒé™

#### 4. ç»„ä»¶å¯¼å…¥å¤±è´¥
```
âŒ ç»„ä»¶å¯¼å…¥å¤±è´¥: ModuleNotFoundError
```
**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥Pythonè·¯å¾„é…ç½®
- ç¡®è®¤æ‰€æœ‰ä¾èµ–åŒ…å·²å®‰è£…
- éªŒè¯é¡¹ç›®ç›®å½•ç»“æ„

## ğŸ” è°ƒè¯•å’Œæ’é”™

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```bash
# è®¾ç½®è¯¦ç»†æ—¥å¿—çº§åˆ«
export LOG_LEVEL=DEBUG

# è¿è¡Œæµ‹è¯•æ—¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
python tests/test_runner.py
```

### å•æ­¥è°ƒè¯•

```python
# åœ¨æµ‹è¯•ä»£ç ä¸­æ·»åŠ æ–­ç‚¹
import pdb; pdb.set_trace()

# æˆ–ä½¿ç”¨printè¾“å‡ºè°ƒè¯•ä¿¡æ¯
print(f"APIå“åº”: {response.status_code} - {response.text}")
```

### æŸ¥çœ‹æµ‹è¯•æ—¥å¿—

```bash
# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
tail -f tests/output/logs/test.log

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´çš„æ—¥å¿—
grep "2025-07-23 14:30" tests/output/logs/test.log
```

## ğŸ“ æ·»åŠ æ–°æµ‹è¯•

### 1. æ·»åŠ å•å…ƒæµ‹è¯•

```python
# tests/unit/test_new_feature.py
import pytest
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../../'))

from src.your_module import YourClass

class TestNewFeature:
    def test_new_functionality(self):
        # æµ‹è¯•é€»è¾‘
        obj = YourClass()
        result = obj.new_method()
        assert result == expected_value
```

### 2. æ·»åŠ é›†æˆæµ‹è¯•

```python
# tests/integration/test_new_integration.py
from tests.utils.test_config import TEST_AUTH_CONFIG

class TestNewIntegration:
    def test_integration_scenario(self):
        # é›†æˆæµ‹è¯•é€»è¾‘
        pass
```

### 3. æ›´æ–°æµ‹è¯•è¿è¡Œå™¨

åœ¨ `tests/test_runner.py` çš„ `run_all_tests` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æµ‹è¯•ï¼š

```python
def run_all_tests(self):
    # ç°æœ‰æµ‹è¯•...
    
    # æ·»åŠ æ–°æµ‹è¯•
    test_results["new_feature"] = self.run_new_feature_tests()
```

## ğŸ¤ æœ€ä½³å®è·µ

1. **æµ‹è¯•ç‹¬ç«‹æ€§**ï¼šæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åº”è¯¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„ç»“æœ
2. **æ•°æ®æ¸…ç†**ï¼šæµ‹è¯•åæ¸…ç†ä¸´æ—¶æ•°æ®ï¼Œé¿å…å½±å“åç»­æµ‹è¯•
3. **å¼‚å¸¸å¤„ç†**ï¼šå……åˆ†æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶
4. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…æµ‹è¯•æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œåˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
5. **æ–‡æ¡£æ›´æ–°**ï¼šæ–°å¢åŠŸèƒ½æ—¶åŠæ—¶æ›´æ–°æµ‹è¯•ç”¨ä¾‹å’Œæ–‡æ¡£

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æµ‹è¯•æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œç¯å¢ƒè®¾ç½®
3. å‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤æŒ‡å—
4. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æŠ€æœ¯æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2025-07-23  
**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: æ•°æ®åŒæ­¥ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ