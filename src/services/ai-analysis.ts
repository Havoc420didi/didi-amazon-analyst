import { deepseek } from '@ai-sdk/deepseek';
import { generateText } from 'ai';
import { ProductAnalysisData, AIAnalysisResult } from '@/types/ai-analysis';

// Deepseek AIåˆ†ææœåŠ¡ç±»
export class DeepseekAnalysisService {
  private apiKey: string;
  private model: string;

  constructor() {
    this.apiKey = process.env.DEEPSEEK_API_KEY || '';
    this.model = 'deepseek-chat';
    
    if (!this.apiKey) {
      throw new Error('DEEPSEEK_API_KEY environment variable is required');
    }
  }

  // ç”Ÿæˆåˆ†ææç¤ºè¯
  private buildAnalysisPrompt(productData: ProductAnalysisData): string {
    const {
      asin,
      product_name,
      warehouse_location,
      total_inventory,
      fba_available,
      fba_in_transit,
      local_warehouse,
      avg_sales,
      daily_revenue,
      inventory_turnover_days,
      inventory_status,
      ad_impressions,
      ad_clicks,
      ad_spend,
      ad_orders,
      acos,
      trends = { inventory_change: 0, revenue_change: 0, sales_change: 0 },
      history = []
    } = productData;

    return `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„äºšé©¬é€Šè¿è¥ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹äº§å“æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æå¹¶ç»™å‡ºä¸“ä¸šçš„è¿è¥å†³ç­–å»ºè®®ï¼š

## äº§å“åŸºæœ¬ä¿¡æ¯
- äº§å“åç§°ï¼š${product_name}
- ASINï¼š${asin}
- åº“å­˜ç‚¹ï¼š${warehouse_location}

## åº“å­˜çŠ¶å†µåˆ†æ
- æ€»åº“å­˜ï¼š${total_inventory}ä»¶
- FBAå¯ç”¨åº“å­˜ï¼š${fba_available}ä»¶
- FBAåœ¨é€”åº“å­˜ï¼š${fba_in_transit}ä»¶
- æœ¬åœ°ä»“åº“å­˜ï¼š${local_warehouse}ä»¶
- åº“å­˜çŠ¶æ€ï¼š${inventory_status || 'æœªçŸ¥'}
- åº“å­˜å‘¨è½¬å¤©æ•°ï¼š${inventory_turnover_days || 'æœªçŸ¥'}å¤©

## é”€å”®è¡¨ç°åˆ†æ
- å¹³å‡æ—¥é”€é‡ï¼š${avg_sales}ä»¶
- æ—¥å‡é”€å”®é¢ï¼š$${daily_revenue}
- åº“å­˜å˜åŒ–è¶‹åŠ¿ï¼š${trends.inventory_change > 0 ? '+' : ''}${trends.inventory_change.toFixed(1)}%
- é”€å”®é¢å˜åŒ–è¶‹åŠ¿ï¼š${trends.revenue_change > 0 ? '+' : ''}${trends.revenue_change.toFixed(1)}%
- é”€é‡å˜åŒ–è¶‹åŠ¿ï¼š${trends.sales_change > 0 ? '+' : ''}${trends.sales_change.toFixed(1)}%

## å¹¿å‘ŠæŠ•æ”¾æ•°æ®
- å¹¿å‘Šæ›å…‰é‡ï¼š${ad_impressions.toLocaleString()}æ¬¡
- å¹¿å‘Šç‚¹å‡»é‡ï¼š${ad_clicks}æ¬¡
- å¹¿å‘ŠèŠ±è´¹ï¼š$${ad_spend}
- å¹¿å‘Šè®¢å•æ•°ï¼š${ad_orders}ä¸ª
- ACOSï¼š${acos ? `${(acos * 100).toFixed(2)}%` : 'æœªçŸ¥'}

${history.length > 0 ? `## å†å²è¶‹åŠ¿æ•°æ®
æœ€è¿‘${history.length}å¤©çš„è¡¨ç°ï¼š
${history.map((h, i) => `${i + 1}. ${h.date}: åº“å­˜${h.inventory}ä»¶, é”€å”®é¢$${h.revenue}, é”€é‡${h.sales}ä»¶`).join('\n')}` : ''}

## ä»»åŠ¡ç›®æ ‡
æ ¹æ®æˆ‘æä¾›çš„å•å“ï¼ˆASINï¼‰åœ¨ç‰¹å®šå¸‚åœºï¼ˆåº“å­˜ç‚¹ï¼‰çš„å„é¡¹æ•°æ®æŒ‡æ ‡ï¼Œç”Ÿæˆä¸€ä»½ç»“æ„æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨çš„â€œåˆ†ææ—¥å¿—â€ã€‚è¿™ä»½æ—¥å¿—å¿…é¡»åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šâ€œåˆ†æâ€å’Œâ€œè¡ŒåŠ¨â€ã€‚

## è¾“å‡ºè¦æ±‚
1.  **è¯­è¨€**: ä½¿ç”¨ç®€ä½“ä¸­æ–‡ã€‚
2.  **æ ¼å¼**: ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„è§£é‡Šæˆ–å®¢å¥—è¯ã€‚
    åˆ†æï¼š[ä½ çš„åˆ†æå†…å®¹]
    è¡ŒåŠ¨ï¼š[ä½ çš„å…·ä½“è¡ŒåŠ¨å»ºè®®]
3.  **è¯­æ°”**: ä¸“ä¸šã€å®¢è§‚ã€æ•°æ®é©±åŠ¨ã€ç®€æ´æ˜äº†ã€‚
4.  **åŸåˆ™**:
    * æ‰€æœ‰åˆ†æå’Œå»ºè®®éƒ½å¿…é¡»åŸºäºæˆ‘æä¾›çš„æ•°æ®ã€‚
    * å¦‚æœæ•°æ®ä¸­æ²¡æœ‰æä¾›æ˜ç¡®çš„â€œå¥½â€æˆ–â€œåâ€çš„åŸºå‡†ï¼Œè¯·ç»“åˆä½ çš„ä¸“å®¶çŸ¥è¯†è¿›è¡Œåˆ¤æ–­ï¼ˆä¾‹å¦‚ï¼Œæ™®éè®¤ä¸ºå¹¿å‘Šè½¬åŒ–ç‡ > 10% æ˜¯ä¸é”™çš„è¡¨ç°ï¼‰ã€‚
    * è¡ŒåŠ¨å»ºè®®å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯æ“ä½œçš„æ­¥éª¤ï¼Œè€Œä¸æ˜¯æ¨¡ç³Šçš„æè¿°ã€‚

## æ•°æ®åˆ†ææ¡†æ¶
è¯·éµå¾ªä»¥ä¸‹é€»è¾‘æ€è·¯è¿›è¡Œåˆ†æï¼š

1.  **åº“å­˜å¥åº·åº¦åˆ†æ**:
    * æ£€æŸ¥â€œåº“å­˜çŠ¶æ€â€ï¼Œå¹¶ç»“åˆâ€œåº“å­˜å‘¨è½¬å¤©æ•°â€è¿›è¡Œåˆ¤æ–­ã€‚å‘¨è½¬å¤©æ•°æ˜¯å¦è¿‡é•¿ï¼ˆå¦‚ > 90å¤©ï¼‰æˆ–è¿‡çŸ­ï¼ˆå¦‚ < 40å¤©ï¼Œå‘é“è·¯è¿è¾“è¡¥è´§ä¼šæœ‰æ–­è´§é£é™©ï¼‰ï¼Œå‘¨è½¬å¤©æ•° = (æ€»åº“å­˜ / æ—¥å‡é”€é‡)ã€‚
    * ç»¼åˆ FBAå¯ç”¨ã€FBAåœ¨é€”ã€æœ¬åœ°ä»“åº“å­˜ï¼Œè¯„ä¼°æ€»åº“å­˜é‡æ˜¯å¦åˆç†ã€‚æ³¨æ„å“åå’Œå¤‡æ³¨ä¸­å¯èƒ½æåˆ°çš„ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚â€œå…±ç”¨åº“å­˜â€ï¼‰ã€‚
    * åŸºäºâ€œå¹³å‡é”€é‡â€ï¼Œé¢„æµ‹å½“å‰æ€»åº“å­˜è¿˜èƒ½ç»´æŒå¤šä¹…çš„é”€å”®ã€‚

2.  **å¹¿å‘Šç»©æ•ˆåˆ†æ**:
    * **åŸºç¡€æŒ‡æ ‡**: è¯„ä¼°â€œå¹¿å‘Šç‚¹å‡»ç‡ (CTR)â€å’Œâ€œå¹¿å‘Šè½¬åŒ–ç‡ (CVR)â€ã€‚å®ƒä»¬æ˜¯å¦åœ¨å¥åº·èŒƒå›´å†…ï¼Ÿï¼ˆä¾‹å¦‚ï¼ŒCTR < 0.4% å¯èƒ½åä½ï¼ŒCVR < 8% å¯èƒ½æœ‰ä¼˜åŒ–ç©ºé—´ï¼‰ã€‚è½¬åŒ–ç‡<10%ï¼šæ£€æŸ¥Listingè´¨é‡æˆ–è€…é™ä½ä»·æ ¼ã€‚ç‚¹å‡»ç‡<0.5%ï¼šä¼˜åŒ–ä¸»å›¾ï¼Œé™ä½ä»·æ ¼ï¼Œæé«˜ç«ä»·ã€‚
    * **æˆæœ¬æ•ˆç›Š**: åˆ†æâ€œACOAS (å¹¿å‘Šæˆæœ¬é”€å”®æ¯”)â€ã€‚è¿™ä¸ªæ•°å€¼æ˜¯è¿‡é«˜ã€åˆç†è¿˜æ˜¯åä½ï¼Ÿå°†â€œå¹¿å‘ŠèŠ±è´¹â€ä¸â€œå¹¿å‘Šè®¢å•é‡â€å¸¦æ¥çš„é”€å”®é¢ï¼ˆéœ€è¦æ ¹æ®æ—¥å‡é”€å”®é¢å’Œå¹³å‡é”€é‡ä¼°ç®—å®¢å•ä»·ï¼‰è¿›è¡Œå¯¹æ¯”ã€‚åˆç†çš„ACOASæ˜¯å¤§äº7%å¹¶ä¸”å°äº15%ï¼Œå¦‚æœè¿‡ä½ï¼Œä»£è¡¨æ²¡æœ‰å¾—åˆ°è¶³å¤Ÿçš„æ¨å¹¿ï¼Œè¿‡é«˜åˆ™æ¨å¹¿æˆæœ¬å æ¯”è¿‡é«˜ï¼Œä¼šå¯¼è‡´æ¯›åˆ©ç‡æ¯”è¾ƒä½ã€‚
    * **å…³è”åˆ†æ**: å°†æ›å…‰é‡ã€ç‚¹å‡»é‡ã€èŠ±è´¹å’Œè®¢å•é‡è”ç³»èµ·æ¥ã€‚æ˜¯å¦å­˜åœ¨â€œé«˜æ›å…‰ã€ä½ç‚¹å‡»â€ï¼ˆå¯èƒ½ä¸»å›¾æˆ–æ ‡é¢˜å¸å¼•åŠ›ä¸è¶³ï¼‰ã€â€œé«˜ç‚¹å‡»ã€ä½è½¬åŒ–â€ï¼ˆå¯èƒ½è½åœ°é¡µã€ä»·æ ¼ã€Reviewæœ‰é—®é¢˜ï¼‰æˆ–â€œé«˜èŠ±è´¹ã€ä½è®¢å•â€ï¼ˆå¹¿å‘Šæ´»åŠ¨æ•ˆç›Šå·®ï¼‰çš„æƒ…å†µï¼Ÿ

3.  **ç»¼åˆè¯Šæ–­ä¸è¡ŒåŠ¨å»ºè®®**:
	- **ä¸»è¦çŸ›ç›¾**ï¼šä¸»è¦çŸ›ç›¾å°±2ä¸ªï¼šè½¬åŒ–ç‡å’Œæµé‡ï¼Œå…ˆè¦è§£å†³è½¬åŒ–ç‡é—®é¢˜ï¼Œåœ¨è½¬åŒ–ç‡ä¸è¾¾æ ‡çš„æ—¶å€™ï¼Œä¸åº”è¯¥èŠ±è¶…è¿‡5ç¾é‡‘/å¤©çš„å¹¿å‘Šï¼Œå› ä¸ºæµé‡å¾ˆè´µï¼Œå¦‚æœå®è´µçš„æµé‡è¿›å…¥äº†ä½ çš„é¡µé¢ï¼Œä½†å´æ²¡æœ‰è½¬åŒ–ä¸ºè®¢å•ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å¯è€»çš„æµªè´¹ã€‚
    * **åˆ†æéƒ¨åˆ†**: ç»¼åˆä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç”¨å‡ å¥è¯æ€»ç»“å½“å‰äº§å“çš„æ ¸å¿ƒä¼˜åŠ¿ã€ä¸»è¦é—®é¢˜å’Œæ½œåœ¨é£é™©ã€‚ä¾‹å¦‚ï¼šâ€œåº“å­˜å‘¨è½¬å¥åº·ï¼Œä½†å¹¿å‘Šæ•ˆç‡ä½ä¸‹ï¼Œè½¬åŒ–ç‡è¿‡ä½æ˜¯å½“å‰ä¸»è¦çŸ›ç›¾ã€‚â€
    * **è¡ŒåŠ¨éƒ¨åˆ†**: é’ˆå¯¹åˆ†æä¸­å‘ç°çš„é—®é¢˜ï¼Œæå‡ºç²¾å‡†çš„è¡ŒåŠ¨æŒ‡ä»¤ã€‚
        * **åº“å­˜é—®é¢˜**: å»ºè®®â€œåŠ å¿«æ¸…è´§â€ã€â€œåˆ›å»ºç§»é™¤è®¢å•â€ã€â€œè”ç³»ä¾›åº”å•†è¡¥è´§â€æˆ–â€œä»æœ¬åœ°ä»“è°ƒæ‹¨è‡³FBAâ€ã€‚
        * **å¹¿å‘Šé—®é¢˜**: å»ºè®®â€œé™ä½æ— æ•ˆå…³é”®è¯çš„å‡ºä»·â€ã€â€œæš‚åœè¡¨ç°å·®çš„å¹¿å‘Šæ´»åŠ¨â€ã€â€œä¼˜åŒ–å¹¿å‘Šç´ æï¼ˆä¸»å›¾/è§†é¢‘ï¼‰â€ã€â€œæé«˜é«˜æ•ˆå…³é”®è¯çš„å‡ºä»·â€ã€â€œå¢åŠ è¡¨ç°å¥½çš„å¹¿å‘Šä½ç½®ï¼ˆå¦‚æœç´¢ç»“æœé¡¶éƒ¨ï¼‰çš„ç«ä»·ç³»æ•°â€ç­‰ã€‚
        * **æŠ¥BDç§’æ€**ï¼šåªè¦æœ‰BDçš„èµ„æ ¼ï¼Œå°½é‡æŠ¥BDï¼Œè¦æ³¨æ„å¤‡è¶³åº“å­˜ã€‚å¦‚æœå½“å‰åº“å­˜è¶³å¤Ÿï¼Œå°±æŠ¥æœ€è¿‘æ—¶é—´çš„BDã€‚å¦‚æœåº“å­˜ä¸è¶³ï¼Œå¯ä»¥å…ˆæŠ¥3å‘¨åçš„BDï¼Œç„¶åç©ºè¿è¡¥è´§è¿‡å»ã€‚é˜²æ­¢BDèµ„æ ¼æ¶ˆå¤±ã€‚

## èƒŒæ™¯çŸ¥è¯†
### çŸ¥è¯†1 ä»€ä¹ˆæ ·çš„è½¬åŒ–ç‡å«åˆæ ¼ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œå®¢å•ä»·è¶Šåº•ï¼Œè½¬åŒ–ç‡åº”è¯¥è¶Šé«˜ã€‚ 
7-10ç¾é‡‘ï¼Œ18% ï¼›
10-15ç¾é‡‘ï¼Œ15% ï¼›
15-20ç¾é‡‘ï¼Œ13% ï¼›
20-25ç¾é‡‘ï¼Œ10% ï¼›
25-30ç¾é‡‘ï¼Œ8% ï¼›
30-35ç¾é‡‘ï¼Œ6% ï¼›
35ä»¥ä¸Š 4%-5%

### çŸ¥è¯†2 å¦‚ä½•æå‡è½¬åŒ–ç‡ï¼Ÿ

é€šå¸¸æœ€å¿«é€Ÿçš„æå‡è½¬åŒ–ç‡çš„æ–¹æ³•æ˜¯é™ä½ä»·æ ¼ï¼Œé™ä½ä»·æ ¼å¯ä»¥ä½¿ç”¨Couponï¼ŒPDï¼Œä¹Ÿå¯ä»¥ç›´æ¥é™ä»·ã€‚ ä½†å¦‚æœåé¢è¦åšBest Dealï¼Œé‚£ä¹ˆæœ€å¥½ç”¨Couponã€‚

æå‡è½¬åŒ–ç‡æ›´é«˜é˜¶çš„æ–¹æ³•ï¼š 
1 ä¼˜åŒ–å›¾ç‰‡å’Œæ ‡é¢˜ã€è¦ç‚¹ã€EBC 
2 ä¼˜åŒ–ä½ çš„æµé‡æ¥æºï¼Œæ‰¾æ›´ç²¾å‡†çš„è¯å»æå‡æ’å 

### çŸ¥è¯†3 å¦‚ä½•æå‡æµé‡ï¼Ÿ

ç¬¬ä¸€ç§æ˜¯ä»äºšé©¬é€Šå¹³å°ç«™å†…è·å¾—æµé‡ã€‚ **äºšé©¬é€Šçš„æµé‡æ˜¯ä¸€ä¸ªå…³é”®è¯æ’åçš„æ¸¸æˆ**ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹å…³é”®è¯å»åšè¿è¥ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨æ—¥å¿—ä¸­è¦è®°å½•å…³é”®è¯æ’åã€‚ å…³é”®è¯æ’åå’Œä½ åœ¨è¿™ä¸ªå…³é”®è¯ä¸‹äº§ç”Ÿçš„è®¢å•æ•°é‡å¼ºç›¸å…³ã€‚

æˆ‘ä»¬åº”è¯¥é€‰æ‹©è½¬åŒ–ç‡æ¯”è¾ƒå¥½ï¼Œåˆæœ‰ä¸€å®šæœç´¢é‡çš„å…³é”®è¯ï¼Œé€šè¿‡å¹¿å‘Šå»å¢åŠ æˆ‘ä»¬åœ¨è¿™ä¸ªå…³é”®è¯ä¸‹çš„å‡ºå•æ•°é‡ï¼Œä»è€Œæå‡æˆ‘ä»¬çš„å…³é”®è¯æ’åï¼Œå¢åŠ æˆ‘ä»¬çš„æµé‡ã€‚

## å¼ºåˆ¶è§„åˆ™
- å¦‚æœACOSå¤§äº60%æˆ–è€…ACOASå¤§äº25%ï¼Œç«‹å³é™ä½å¹¿å‘ŠBID 10%æˆ–è€…æ›´å¤šã€‚
- å¦‚æœè½¬åŒ–ç‡å°äºåˆç†è½¬åŒ–ç‡çš„80%ï¼Œåˆ™ç«‹å³æŠŠå¹¿å‘Šbidé™ä½åˆ°0.1ï¼Œä¼˜åŒ–é“¾æ¥æˆ–è€…è°ƒæ•´ä¿ƒé”€åå†å»æµ‹è¯•å¹¿å‘Šã€‚ä¾‹å¦‚9ç¾é‡‘äº§å“çš„åˆç†è½¬åŒ–ç‡æ˜¯18%ï¼Œé‚£ä¹ˆå°äº18%ä¹˜ä»¥0.7 = 12.6%çš„è½¬åŒ–ç‡çš„äº§å“ï¼Œåº”è¯¥ç«‹å³æŠŠå¹¿å‘Šbidé™ä½åˆ°0.1ï¼Œä¼˜åŒ–é“¾æ¥æˆ–è€…è°ƒæ•´ä¿ƒé”€åå†å»æµ‹è¯•å¹¿å‘Šã€‚
- Couponæ¯”ä¾‹æ­£å¸¸ä¸èƒ½é«˜äº20%ï¼Œæœ€å¤šæ˜¯15%ï¼Œå¦‚æœè¦é«˜äº20%éœ€è¦å‘ä¸»ç®¡ç”³è¯·ã€‚
- ä¸èƒ½åˆ›å»ºç§»é™¤è®¢å•ã€‚
- è½¬åŒ–ç‡è¾¾åˆ°åˆç†èŒƒå›´çš„å¹¿å‘Šè®¡åˆ’ï¼Œä¸èƒ½å…³é—­ï¼Œå¦‚æœè¦é™ä½å¹¿å‘ŠèŠ±è´¹ï¼Œå¯ä»¥æŠŠå¹¿å‘Šé¢„ç®—è°ƒåˆ°1ï¼Œå¹¿å‘ŠBIDè°ƒæ•´åˆ°0.1ã€‚
- ä¸è¦è°ƒæ•´å¹¿å‘Šçš„ç«ä»·ç³»æ•°
- æå‡å…³é”®è¯æ’åæˆ–è€…å¢åŠ é”€é‡ä¼˜å…ˆè€ƒè™‘7 å¤©é™æ—¶ç§’æ€ï¼ˆBest Dealï¼‰è¿™ä¸ªæ‰‹æ®µã€‚
- åœ¨ACOAS é«˜äº15%æ—¶ï¼Œä¸èƒ½å¢åŠ å¹¿å‘Šé¢„ç®—ã€‚
- å¯¹äºè½¬åŒ–ç‡è¾¾åˆ°åˆç†åŒºé—´çš„å…³é”®è¯ï¼Œå¯ä»¥æ¯æ¬¡æå‡10%-15%çš„BID
- å¯¹äºACOS >45%çš„æ— æ•ˆå…³é”®è¯ï¼Œå¯ä»¥å°† BID ä¸‹è°ƒ 10%ï¼Œè§‚å¯Ÿ 3 å¤©åç»§ç»­ä¼˜åŒ–ã€‚
- ç‚¹å‡»ç‡é«˜äº0.5%ï¼Œå°±ä¸ç”¨ä¼˜åŒ–ç‚¹å‡»ç‡äº†ã€‚
- ä¸è¦æ¨èå…·ä½“çš„å…³é”®è¯ï¼Œå¯ä»¥ç”¨â€æ ¸å¿ƒå…³é”®è¯â€œæˆ–è€…â€ç²¾å‡†é•¿å°¾è¯â€œï¼Œè¿™æ ·çš„è¯´æ³•ã€‚
- èŠ‚æ—¥ç±»äº§å“ï¼Œå¾ˆå®¹æ˜“è¿‡å­£ï¼Œä¸èƒ½è¡¥è´§

# è¾“å‡ºæ¡ˆä¾‹
## åˆ†æï¼š
1. **åº“å­˜å¥åº·åº¦**: åº“å­˜ä¸¥é‡è¿‡å‰©ã€‚æ€»åº“å­˜2495ä»¶ï¼ŒåŸºäºæ—¥å‡11.8çš„é”€é‡ï¼Œåº“å­˜å‘¨è½¬å¤©æ•°é«˜è¾¾211.4å¤©ï¼Œè¿œè¶…äº90å¤©çš„å¥åº·èŒƒå›´ï¼Œåº“å­˜çŠ¶æ€ä¸ºâ€œå‘¨è½¬è¶…æ ‡â€ï¼Œå­˜åœ¨æé«˜çš„é•¿æœŸä»“å‚¨è´¹é£é™©å’Œèµ„é‡‘ç§¯å‹é—®é¢˜ã€‚
    
2. **å¹¿å‘Šç»©æ•ˆ**: å¹¿å‘Šæ•ˆç‡åä½ï¼Œæ˜¯å½“å‰äºŸå¾…è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚
    
    - **è½¬åŒ–ç‡**: æ ¹æ®çº¦$8.96çš„å®¢å•ä»·ï¼ˆ$105.73 / 11.8ï¼‰ï¼Œ15%çš„å¹¿å‘Šè½¬åŒ–ç‡ï¼ˆCVRï¼‰æœªè¾¾åˆ°è¯¥ä»·æ ¼åŒºé—´20%çš„ä¼˜ç§€æ ‡å‡†ã€‚è¿™æ˜¯å¯¼è‡´å¹¿å‘Šæ•ˆç›Šä¸ä½³çš„æ ¹æœ¬åŸå› ã€‚
        
    - **æˆæœ¬æ•ˆç›Š**: 15.12%çš„ACOASå·²è¾¾åˆ°15%åˆç†åŒºé—´çš„ä¸Šé™ï¼Œè¡¨æ˜å¹¿å‘Šæˆæœ¬å æ¯”è¾ƒé«˜ï¼ŒæŒ¤å‹äº†åˆ©æ¶¦ç©ºé—´ã€‚
        
    - **ç‚¹å‡»ç‡**: 0.54%çš„å¹¿å‘Šç‚¹å‡»ç‡ï¼ˆCTRï¼‰å°šåœ¨0.5%çš„å¯æ¥å—åŸºå‡†çº¿ä¸Šï¼Œè¯´æ˜ä¸»å›¾å’Œæ ‡é¢˜æœ‰ä¸€å®šå¸å¼•åŠ›ï¼Œä½†ä¸»è¦é—®é¢˜å‡ºåœ¨æµé‡è¿›å…¥é¡µé¢åçš„è½¬åŒ–ç¯èŠ‚ã€‚
        
3. **ç»¼åˆè¯Šæ–­**: å½“å‰çš„ä¸»è¦çŸ›ç›¾æ˜¯è½¬åŒ–ç‡ä¸è¶³ã€‚è¿™ä¸ªé—®é¢˜ç›´æ¥å¯¼è‡´äº†å¹¿å‘ŠæŠ•å…¥äº§å‡ºæ¯”ä¸ä½³ï¼Œå¹¶ä¸”ä½¿å¾—åºå¤§çš„åº“å­˜æ— æ³•è¢«æœ‰æ•ˆæ¶ˆåŒ–ã€‚å¿…é¡»ä¼˜å…ˆè§£å†³è½¬åŒ–ç‡é—®é¢˜ï¼Œæ‰èƒ½ç»§è€Œè§£å†³åº“å­˜ç§¯å‹çš„é£é™©ã€‚
    

## è¡ŒåŠ¨ï¼š

1. **æå‡è½¬åŒ–ç‡ä¸é”€é‡**: ç«‹å³åˆ›å»ºä¸€ä¸ª15%çš„Couponï¼Œä»¥æœ€å¿«é€Ÿåº¦æå‡è½¬åŒ–ç‡å’Œæ—¥å‡é”€é‡ï¼Œå¼€å§‹æ¶ˆåŒ–ç§¯å‹åº“å­˜ã€‚æŒç»­ç›‘æ§å¼€å¯å3å¤©å†…çš„è½¬åŒ–ç‡å’Œé”€é‡æ•°æ®ã€‚
    
2. **æ§åˆ¶å¹¿å‘Šæˆæœ¬**: é‰´äºè½¬åŒ–ç‡åä½åŠACOASåé«˜ï¼Œç«‹å³å°†æ‰€æœ‰å¹¿å‘Šæ´»åŠ¨çš„å‡ºä»·ï¼ˆBIDï¼‰ç»Ÿä¸€é™ä½10%ï¼Œä»¥æ§åˆ¶å¹¿å‘ŠèŠ±è´¹ï¼Œæå‡åˆ©æ¶¦ç‡ã€‚
    
3. **åº“å­˜ç®¡æ§**: ç«‹å³æš‚åœå‘è¯¥ASINçš„è‹±å›½åº“å­˜ç‚¹è¿›è¡Œä»»ä½•å½¢å¼çš„è¡¥è´§ï¼ˆåŒ…æ‹¬æœ¬åœ°ä»“è°ƒæ‹¨ï¼‰ï¼Œç›´åˆ°åº“å­˜å‘¨è½¬å¤©æ•°ä¸‹é™è‡³90å¤©ä»¥å†…ã€‚
    
4. **ä¼˜åŒ–è¯¦æƒ…é¡µé¢**: åœ¨æ‰§è¡Œä»·æ ¼ä¿ƒé”€çš„åŒæ—¶ï¼Œå¯¹äº§å“è¯¦æƒ…é¡µé¢ï¼ˆListingï¼‰è¿›è¡Œä¼˜åŒ–ã€‚é‡ç‚¹æ£€æŸ¥å’Œæ”¹è¿›æè¿°è¦ç‚¹ï¼ˆBullet Pointsï¼‰å’ŒA+é¡µé¢ï¼Œç¡®ä¿å…¶èƒ½å¤Ÿæ¸…æ™°åœ°ä¼ è¾¾äº§å“ä»·å€¼ï¼Œä»¥æå‡é•¿æœŸè‡ªç„¶è½¬åŒ–ç‡ã€‚

è¯·ç«‹å³å¼€å§‹åˆ†æå¹¶ç”Ÿæˆâ€œåˆ†ææ—¥å¿—â€ã€‚
`;
  }

  // è§£æåˆ†æç»“æœ
  private parseAnalysisResult(content: string): {
    recommendations: {
      inventory_action: string;
      sales_strategy: string;
      ad_optimization: string;
      risk_level: 'low' | 'medium' | 'high';
    };
  } {
    // æå–å„éƒ¨åˆ†å†…å®¹
    const inventoryMatch = content.match(/### åº“å­˜ç®¡ç†\s*([\s\S]*?)(?=###|$)/);
    const salesMatch = content.match(/### é”€å”®ç­–ç•¥\s*([\s\S]*?)(?=###|$)/);
    const adMatch = content.match(/### å¹¿å‘Šä¼˜åŒ–\s*([\s\S]*?)(?=###|$)/);
    const riskMatch = content.match(/## ğŸš¨ é£é™©ç­‰çº§\s*([\s\S]*?)(?=##|$)/);

    // ç¡®å®šé£é™©ç­‰çº§
    let risk_level: 'low' | 'medium' | 'high' = 'medium';
    if (riskMatch && riskMatch[1]) {
      const riskText = riskMatch[1].toLowerCase();
      if (riskText.includes('ä½é£é™©') || riskText.includes('low')) {
        risk_level = 'low';
      } else if (riskText.includes('é«˜é£é™©') || riskText.includes('high')) {
        risk_level = 'high';
      }
    }

    return {
      recommendations: {
        inventory_action: inventoryMatch ? inventoryMatch[1].trim() : 'æœªèƒ½è§£æåº“å­˜å»ºè®®',
        sales_strategy: salesMatch ? salesMatch[1].trim() : 'æœªèƒ½è§£æé”€å”®ç­–ç•¥',
        ad_optimization: adMatch ? adMatch[1].trim() : 'æœªèƒ½è§£æå¹¿å‘Šä¼˜åŒ–å»ºè®®',
        risk_level
      }
    };
  }

  // ç”ŸæˆAIåˆ†æ
  async generateAnalysis(productData: ProductAnalysisData): Promise<AIAnalysisResult> {
    const startTime = Date.now();
    
    try {
      const prompt = this.buildAnalysisPrompt(productData);
      
      const result = await generateText({
        model: deepseek(this.model),
        prompt,
        maxTokens: 2000,
        temperature: 0.7,
      });

      const processingTime = Date.now() - startTime;
      const parsedResult = this.parseAnalysisResult(result.text);

      return {
        analysis_content: result.text,
        processing_time: processingTime,
        tokens_used: result.usage?.totalTokens || 0,
        recommendations: parsedResult.recommendations
      };
    } catch (error) {
      console.error('Deepseek analysis failed:', error);
      throw new Error(`AIåˆ†æç”Ÿæˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
    }
  }

  // ç”Ÿæˆä»»åŠ¡ç¼–å·
  static generateTaskNumber(): string {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 6);
    return `AI${timestamp}${random}`.toUpperCase();
  }

  // éªŒè¯äº§å“æ•°æ®å®Œæ•´æ€§
  static validateProductData(data: ProductAnalysisData): { valid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!data.asin) errors.push('ASINä¸èƒ½ä¸ºç©º');
    if (!data.product_name) errors.push('äº§å“åç§°ä¸èƒ½ä¸ºç©º');
    if (!data.warehouse_location) errors.push('åº“å­˜ç‚¹ä¸èƒ½ä¸ºç©º');
    if (data.total_inventory < 0) errors.push('æ€»åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°');
    if (data.avg_sales < 0) errors.push('å¹³å‡é”€é‡ä¸èƒ½ä¸ºè´Ÿæ•°');
    if (data.daily_revenue < 0) errors.push('æ—¥å‡é”€å”®é¢ä¸èƒ½ä¸ºè´Ÿæ•°');

    return {
      valid: errors.length === 0,
      errors
    };
  }
}

// å•ä¾‹æ¨¡å¼å¯¼å‡º
let analysisService: DeepseekAnalysisService | null = null;

export function getAnalysisService(): DeepseekAnalysisService {
  if (!analysisService) {
    analysisService = new DeepseekAnalysisService();
  }
  return analysisService;
}